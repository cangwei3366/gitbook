---
title: Map - TreeSet & TreeMap源码解析
date: 2021-03-18 14:49:48
permalink: /pages/38003e/
categories:
  - Java
  - Java进阶-集合框架
tags:
  - 
---
红黑树性质
1.结点不是红色就是黑色。
2.根节点一定为黑色。
3.所有的NULL指针被认为是黑色结点。
4.红色结点的两个孩子一定是黑色。
5.从任一节点到其每个叶子的所有简单路径上的黑色结点数都相同。
红黑树之插入
总结：
1.N为根节点
涂黑即可

2.父黑
直接插入即可

3.父红-叔红
父/叔涂黑，祖父涂红；祖父节点作为新的平衡节点递归进行平衡

4.父红-叔黑
父N同侧
    父N同左 以祖父节点右旋，父和祖父节点颜色互换
    父N同右    以祖父节点左旋，父和祖父节点颜色呼唤
父N异侧
    父左N右    以父节点进行左旋，父成为新的平衡节点，再进行父N同左
    父右N左    以父节点进行右旋，父成为新的平衡节点，再进行父N同右

新插入节点均为红色节点。
N为新增节点
情形1. N为根节点
当前平衡节点N为根节点时，直接涂黑根节点即可。
![](../img/01_06_00.png)
情形2. 父黑
父节点为黑色时，无需其他操作。
![](../img/01_06_01.png)
情形3.父红-叔红
父红-叔红时，将父/叔节点涂黑，祖父节点涂红；而后祖父节点作为新的平衡节点N，递归执行平衡操作。
![](../img/01_06_02.png)
情形4.父红-叔黑
4.1 父节点和N同一侧
4.1.1父N同左
此时以祖父节点为支点右旋；然后p作为原GP的代替，为保持兼容性涂黑；GP涂红是因为右旋后，经过U的路径的黑色节点数量+1，涂红进行数量平衡
![](../img/01_06_03.png)   
4.1.2父N同右
此时以祖父节点GP为支点进行左旋；将P涂黑，将GP涂红。
![](../img/01_06_04.png) 
4.2父节点和N不在同一边
4.2.1父左N右
此时，以父节点进行左旋，旋转后，以P作为新的平衡节点N，转至4.1.1 父N同左处理。
![](../img/01_06_05.png) 
4.2.2 父右N左
此时，以父节点进行右旋，旋转后，以P作为新的平衡节点N，转至4.1.1 父N同右处理。
![](../img/01_06_06.png) 
例：插入10，20，15，30，5，8；
![](../img/01_06_07.png) 

红黑树之删除

二叉树删除节点找替代节点的3种情景：
情景1：若删除结点无子结点，直接删除
情景2：若删除结点只有一个子结点，用子结点替换删除结点
情景3：若删除节点有两个子节点，则用后继结点（大于删除结点的最小结点）替换删除结点
情景3可转换为情景1、2。
总结：
1.N为根节点 无子节点

2.兄弟节点为黑色
    2.1兄弟的子节点全为黑色
        2.1.1父节点为黑色
        兄弟涂红，父节点作为新的平衡节点递归
        
        2.1.2父节点为红色
        将兄弟涂红，父亲涂黑
        
    2.2兄弟的子节点不全为黑    
    S为左子时（即N为右子），主要分为两组[SL=红]、[SL=黑]；
    S为右子时（即N为左子），主要分为两组[SR=红]、[SR=黑];

    [S为左子，SL红](以P右旋，SL变黑，P和S交换颜色)与[S为右子，SR红](以P左旋;交换P和S颜色，SR变黑)处理方式对称
    [S为左子，SL黑](以S左旋，SR和S交换颜色，转至S左-SL红处理)与[S为右子，SR黑](以S右旋，SL和S交换颜色，转至S右-SR红处理)处理方式对称
    
    
3.兄弟节点为红色    
    S为左子时，以P进行右旋;
    S为右子时，以P进行左旋;
    交换P和S颜色(S涂黑，P涂红)，进入兄弟节点为黑色处理。
情形1 当前节点为根节点
直接删除，无需平衡操作
情形2 兄弟节点为黑色（s=黑）
情形2.1 兄弟的子节点全黑（SL/SR =黑）
兄弟节点的子节点全为黑色，也就意味着兄弟节点S可以涂红而不会和子节点冲突。S涂红后，也就实现了子平衡
情形2.1.1 父节点为黑色（P=黑）
此时将S涂红，父节点作为新的平衡节点N，递归上去处理。
![](../img/01_06_08.png) 
情形2.1.2 父节点为红色
此时将S涂红，P涂黑，平衡结束。
![](../img/01_06_09.png) 
情形2.2兄弟的子节点不全黑
S为左子时（即N为右子），主要分为两组[SL=红]、[SL=黑]；
S为右子时（即N为左子），主要分为两组[SR=红]、[SR=黑];

[S为左子，SL红]与[S为右子，SR红]处理方式对称
[S为左子，SL黑]与[S为右子，SR黑]处理方式对称
情形2.2.1 S为左子，SL红；S为右子，SR红
情形(1)S为黑色，S为左子，SL红时：
![](../img/01_06_10.png) 
对称的情形(2)：S为黑色，S为右子，SR红时：
以P为支点左旋；交换P和S颜色，SR涂黑
情形2.2.2 S为左子，SL黑；S为右子，SR黑
情形(1)S为黑色，S为左子，SL黑
以S为支点左旋，交换S和SR颜色，此时转至情形 2.2.1-(1) S左-SL红 进行处理。
![](../img/01_06_11.png) 
情形(2)S为黑色，S为右子，SR黑
以S为支点右旋，交换S和SL颜色，此时转至情形 2.2.1-(1) S右-SR红 进行处理。
![](../img/01_06_12.png) 
情形3 兄弟节点为红色（S=红）
情形(1) S为左子时，以P进行右旋；
情形(2) S为右子时，以P进行左旋；
   旋转后交换P和S的颜色（S涂黑，P涂红），N兄弟节点变为黑色，进入情形2-兄弟节点为黑色进行处理。
![](../img/01_06_13.png) 
总结：
兄黑  兄子全黑       父黑--->兄弟涂红，父节点作为新的平衡节点
                    父红--->父亲和兄弟交换颜色
      兄子不全黑    1.兄黑左，兄左子为红-->以父节点为支点右旋，交换P和S颜色，SL变黑
                    2.兄黑右，兄右子为红-->以父节点为支点左旋，交换P和S颜色，SR变黑     
                    3.兄黑左，兄左子为黑-->以兄为支点左旋，交换S和SR颜色，后续转情况1                    
                    4.兄黑左，兄右子为黑-->以兄为支点右旋，交换S和SL颜色，后续情况转2

兄红                 1.S为左子时，以P为支点进行右旋
                    2.S为右子时，为P为支点进行左旋
                        旋转后交换P和S的颜色，以N转情形2
![](../img/01_06_14.png)                 





