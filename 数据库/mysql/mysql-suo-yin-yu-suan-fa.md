# MYSQL索引与算法

​ 索引是应用程序设计和开发的一个重要方面。若索引太多，应用程序的性能可能会受到影响。而索引太少，对查询性能又会受到影响。所以找到一个合适的平点，这对应用程序的性能至关重要。建议在知道数据的使用后，在数据库设计处就做好索引设计。

​ InnoDB存储引擎支持以下几种常见索引。

## 1. B+树索引

B+树是由二叉查找树，再由平衡二叉树（左右子树高度差最大为1）演化，B+树索引并不能找到一个给定键值的具体行，只能找到被查找数据所在的页。在将页读入内存后进行查找。 插入的3种情况：

| LeafPage满 | IndexPage满 | 操作                         |
| --------- | ---------- | -------------------------- |
| no        | no         | 直接插入                       |
| yes       | no         | 中间的放上面，中间左侧的拆左边，中间右边的放右边节点 |
| yes       | yes        | indexPage中间的节点放上面，其余同上     |

旋转：leafPage满，左右兄弟没满，作旋转减少拆分操作。

一般高度为二到四；

这是最简单的一种情况，实际上略有不同，且没有涉及到并发。

组成：

*   聚集索引

    通常表中数据按主键顺序存放。而聚集索引就是按每张表的主键构造一颗B+树，同时叶子节点存放的是整张表的数据记录。每个数据页都通过一个双向链表连接，页中的记录也是双向链表连接

    查看表索引 show index from tablename

    创建索引 CREATE/DROP {unique} index indexName {indexType} on tablename
*   非聚集索引

    叶子节点不包含行记录的所有数据，叶子节点的索引行告诉innodb从哪里可以找到与索引相对应的行数据。相当于对应行数据的聚集索引键。

应用:

*   联合索引

    CREATE TABLE t{ a int, b int, key idx\_a\_b (a,b) }

    联合索引本质也是一颗二叉树，不同是联合索引的键值数量大于等于2。 且a,b都经过了排序
*   覆盖索引

    即从覆盖索引中得到查询的记录。 好处是叶子节点并不包含整行记录的所有信息，故大小远小于聚集索引，可以减少大量的IO操作. 统计操作一般优化器会使用覆盖索引，而不是联合索引 FORCE INDEX(KEY) 会强制使用某个索引

## 2. 全文索引

like '%xxx%'操作支持B+索引 InnoDB1.2.x版本后支持全文检索其支持MYISAM的全部功能

*   实现

    倒排索引

    * invert file index {单词，所在文档ID}
    * fill inverted index{单词,(所在文档ID,所在文档位置)}

## 3. 哈希索引

hash算法的复杂度为O(1)。 同理参考HashMap的链地址法

* 应用
  *   缓冲池的哈希表

      pos = n%m m的大小略大于2倍缓冲池页数量的质数。 Innodb存储引擎的表空间都有一个space\_id，用户查询的是某个表空间某个连续16kb的页，即偏移量offset。 即k = space\_id <<20 +space\_id+offset
  *   自适应哈希索引

      只支持等值查询，不支持范围查询
